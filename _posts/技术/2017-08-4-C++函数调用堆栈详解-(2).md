---
layout: post
title: C++函数调用堆栈详解-(2)
category: 技术
tags: Linux
keywords: 
description: 
---

## 函数的运行

从main函数开始程序的运行是怎样的一个过程，程序是怎么给一个函数输入参数的？程序是如何知道函数的返回结果的？林纳斯曾经说过我们应该对我们所写的代码运行的细节完全了解才是一个合格的程序员。

### 1.X86-64CPU的寄存器介绍
    
在了解64位处理器寄存器之前先了解一下32cpu的寄存器，如下表格所示：

#### 32位CPU寄存器

寄存器 | 名称 | 作用
---|---|---
数据寄存器 | EAX,EBX,ECX,EDX | 存储中间数居，同时用作函数返地址等数据存储
变址和指针寄存器 | ESI,EDI | 存储器指针，源操作数指针和目的操作数指针
指针寄存器 | ESP、EBP | sp是栈顶指针，bp栈基指针
段寄存器 | ES、CS、SS、DS、FS、GS | 主要用来进行程序的寻址
指令指针寄存器 | EIP | 指向下一条指令的地址
标志寄存器 | EFlags | 记录状态系统和控制标志

上面寄存器中其中EAX、EBX、ECX、EDX、ESP、EBP、ESI、EDI  这8个称为通用寄存器。可以直接进行操作并没有限制。

#### 64位CPU寄存器

在X86-64CPU中所有的寄存器都是64位的，32位寄存器是32位的并且部分寄存器还分高16位和低16位，相对于32位的x86cpu，标识符发生了很大变化，比如linux下gcc汇编代码中%ebp变成了%rbp，并且向后兼容，%ebp也可以使用只想%rbp的低32位。同时X86-64上还新加了8个寄存器，加上原来的8个一共16个寄存器，寄存器速度很快，寄存器多了以后编译器可以针对程序做更多的优化，性能也提高更多。X86-64CPU寄存器分别是：
    
    %rax，%rbx，%rcx，%rdx，%esi，%edi，%rbp，%rsp，%r8，%r9，%r10，%r11，%r12，%r13，%r14，%r15
    
- 其中%rax作为返回值使用。
- %rsp指向栈顶。
- %rdi，%rsi，%rdx，%rcx，%r8，%r9 用作函数参数，依次对应第1参数，第2参数。。。
- %rbx，%rbp，%r12，%r13，%14，%15 用作数据存储，遵循被调用者使用规则，简单说就是随便用，调用子函数之前要备份它，以防他被修改
- %r10，%r11 用作数据存储，遵循调用者使用规则，简单说就是使用之前要先保存原值。

## 栈帧

C语言最大特点就是讲函数过程分解为若干个过程（函数）而在程序运行的时候，这些函数就变成了栈帧，其中%ebp指向栈基地址，%esp指向栈顶地址用于区分一个栈。一个程序堆栈图如下：

![image](/public/img/tech/stack1.png) 

